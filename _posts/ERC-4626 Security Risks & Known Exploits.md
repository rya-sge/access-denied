## ERC-4626 Security Risks & Known Exploits

### 1. **Oracle & Exchange Rate Manipulation (“Donation Attack”)**

**What happened:**
 On **February 27, 2025**, an attacker exploited a wrapped ERC-4626 vault (wUSDM) belonging to Mountain Protocol. Using a **flash loan** of ~$4M from Aave, they executed what's known as a **donation attack**, artificially inflating the vault's internal exchange rate from ~1.06 to ~1.70. They then self-liquidated on Venus Protocol and walked away with a ~$200K profit—while Venus lost over $716K [The Block](https://www.theblock.co/post/348785/analysis-of-700k-oracle-manipulation-exploit-highlights-vulnerabilities-in-defi-vaults?utm_source=chatgpt.com)[Binance](https://www.binance.com/en/square/post/22283196009242?utm_source=chatgpt.com).

**Root cause:**
 ERC-4626 lacks built-in protections against sudden, anomalous yield/increase manipulations. Auction-based vaults or lending protocols often rely on internal price data without safeguards, making them vulnerable to flash-loan-driven distortion [The Block](https://www.theblock.co/post/348785/analysis-of-700k-oracle-manipulation-exploit-highlights-vulnerabilities-in-defi-vaults?utm_source=chatgpt.com)[Binance](https://www.binance.com/en/square/post/22283196009242?utm_source=chatgpt.com).

**Mitigations:**

- Use **cross-chain oracles** or **time-weighted average price (TWAP)** feeds.
- Adopt yield capping mechanisms like **Aave’s CAPO** to limit upside manipulation [The Block](https://www.theblock.co/post/348785/analysis-of-700k-oracle-manipulation-exploit-highlights-vulnerabilities-in-defi-vaults?utm_source=chatgpt.com)[Binance](https://www.binance.com/en/square/post/22283196009242?utm_source=chatgpt.com).
- Combine multiple risk mitigations (e.g., oracle safeguards + rate caps).

------

### 2. **Inflation Attack via Rounding or Front-Running**

**Explained by MixBytes (2025):**
 In vaults based on OpenZeppelin’s ERC-4626 implementation, the formula for calculating shares from assets can be manipulated through **donation + front-running**, causing rounding issues. Specifically, if an attacker sends a large donation right before a victim's deposit, they can skew the denominator in the share calculation and cause the victim to receive **zero shares** despite depositing—letting the attacker siphon assets [mixbytes.io](https://mixbytes.io/blog/overview-of-the-inflation-attack?utm_source=chatgpt.com).

**Why it’s dangerous:**
 Without guardrails, vaults may inadvertently grant zero shares or mishandle rounding, leading to disproportionately favorable outcomes for attackers.

------

### 3. **Incorrect Rounding Leading to Theft**

**Deep dive by Arbitrary Execution:**
 When rounding rules are misapplied, attackers can exploit edge cases. For instance, after a small reward or donation inflates `totalAssets`, an attacker might withdraw a minuscule asset amount (like 1 wei). The contract calculates the shares to burn using integer division, rounding down to **0 shares**. The attacker receives assets for free while retaining their shares—and potentially triggering underflows when others attempt withdrawals [Medium](https://medium.com/arbitrary-execution/shared-vulnerabilities-between-erc-4626-vaults-and-vault-like-contracts-deep-dive-part-2-cb78d404d7cb?utm_source=chatgpt.com).

**Key lessons:**

- ERC-4626 mandates strict rounding directions:
  - **Round down** when issuing shares or transferring assets.
  - **Round up** when calculating required shares/assets from the user.
- Deviating from these rules can lead to theft through rounding errors [Medium](https://medium.com/arbitrary-execution/shared-vulnerabilities-between-erc-4626-vaults-and-vault-like-contracts-deep-dive-part-2-cb78d404d7cb?utm_source=chatgpt.com).

------

### 4. **Asynchronous Vault Vulnerabilities**

**From EIP-7540 (Asynchronous ERC-4626):**
 Asynchronous states and delayed operations complicate security. Without tight control, **pending deposits or redeems** can be misappropriated. Proper **access control** is critical—for example, ensuring only the rightful `msg.sender` can claim pending assets or shares to avoid theft of claims [ercs.eips.fyi](https://ercs.eips.fyi/7540/?utm_source=chatgpt.com).

------

## Illustrative Security Table

| Vulnerability Type         | Risk Summary                                                 | Known Example                                                | Mitigation Strategy                                          |
| -------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **Oracle manipulation**    | Flash-loan/fake yield drives fake exchange rate              | wUSDM donation attack on February 27, 2025 [The Block](https://www.theblock.co/post/348785/analysis-of-700k-oracle-manipulation-exploit-highlights-vulnerabilities-in-defi-vaults?utm_source=chatgpt.com)[Binance](https://www.binance.com/en/square/post/22283196009242?utm_source=chatgpt.com) | CAPO, TWAP oracles, cross-chain price feeds                  |
| **Front-run inflation**    | Donation skews share calculation, resulting in zero shares for victims | MixBytes 2025 analysis [mixbytes.io](https://mixbytes.io/blog/overview-of-the-inflation-attack?utm_source=chatgpt.com) | Anti-front-running logic, reentrancy guards, deposit caps    |
| **Rounding errors**        | Attacker executes free withdrawals due to rounding mis-logic | Arbitrary Execution [Medium](https://medium.com/arbitrary-execution/shared-vulnerabilities-between-erc-4626-vaults-and-vault-like-contracts-deep-dive-part-2-cb78d404d7cb?utm_source=chatgpt.com) | Strict rounding rules, security review of arithmetic edge cases |
| **Delayed/pending claims** | Pending withdrawals/deposits could be stolen if not access-controlled | EIP-7540 asynchronous vaults [ercs.eips.fyi](https://ercs.eips.fyi/7540/?utm_source=chatgpt.com) | Enforce `msg.sender == owner`, cancellation features, invariant checks |

------

## Broader Context

While these examples focus on ERC-4626-specific risks, many vulnerabilities also stem from core DeFi pitfalls—reentrancy, oracle manipulation, logic bugs. For instance:

- **Grim Finance (2021):** A vault contract was reentrancy-exploited—attackers tricked the vault with fake deposits while an initial transaction was in flight [Reddit](https://www.reddit.com/r/CryptoCurrency/comments/rl3oec?utm_source=chatgpt.com).
- **Conic Finance (2023):** A large hack (~1,700 ETH) caused by read-only reentrancy coupled with oracle manipulation [Reddit+1](https://www.reddit.com/r/CryptoCurrency/comments/155pm5a?utm_source=chatgpt.com).

> “Every day now” — Typical sentiment on crypto exploits [Reddit](https://www.reddit.com/r/CryptoCurrency/comments/155pm5a?utm_source=chatgpt.com)

------

## Summary & Takeaways

- **Oracle attacks** show that ERC-4626 vaults need layered protection against flash-loan yield manipulations.
- **Inflation/front-running exploits** exploit the mathematical formulas of share calculation—strict handling of rounding and transaction ordering is essential.
- **State inconsistencies** in asynchronous vaults invite theft unless well-controlled access patterns are enforced.
- **Mitigations** include well-audited implementations (e.g., OpenZeppelin or Solmate), usage of robust oracles, rounding discipline, transaction flow safeguards, and auditing.

Would you like help drafting a secure ERC-4626 vault pattern or code snippets for mitigation (e.g., using CAPO or TWAP)?